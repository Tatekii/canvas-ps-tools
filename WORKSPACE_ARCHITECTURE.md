# 工作区架构设计文档

## 概述

本文档记录了画布工作区的架构设计决策，解决了多图层叠加与无限画布功能之间的平衡问题。

## 架构决策

### 问题背景

在实现多图层叠加功能时，面临以下关键问题：
1. **性能vs灵活性**：无限画布提供灵活性但可能导致性能问题
2. **内存管理**：多图层在无限空间中的内存使用控制
3. **用户体验**：传统图像编辑vs现代设计工具的工作流程

### 解决方案：混合架构

采用**工作区(Workspace) + 虚拟视口(Virtual Viewport)**的混合架构：

```
┌─────────────────────────────────────┐
│           虚拟空间 (无限)              │
│  ┌─────────────────────────────┐    │
│  │     工作区 (Workspace)       │    │
│  │  ┌─────────────────────┐    │    │
│  │  │   视口 (Viewport)    │    │    │
│  │  │                    │    │    │
│  │  │      图层内容       │    │    │
│  │  │                    │    │    │
│  │  └─────────────────────┘    │    │
│  └─────────────────────────────┘    │
└─────────────────────────────────────┘
```

## 核心概念

### 1. 工作区 (Workspace)
- **定义**：项目的主要工作边界，类似Photoshop的画布
- **特性**：
  - 有明确的尺寸边界
  - 支持动态扩展
  - 决定最终导出尺寸
  - 提供网格和参考线

### 2. 虚拟视口 (Virtual Viewport)  
- **定义**：用户当前可见的区域
- **特性**：
  - 可以平移和缩放
  - 决定渲染范围
  - 支持无限平移（在合理范围内）

### 3. 图层空间 (Layer Space)
- **定义**：图层可以存在的虚拟空间
- **特性**：
  - 图层可以超出工作区边界
  - 支持任意位置放置
  - 渲染时自动裁剪到视口

## 技术实现

### 配置参数

```typescript
// 工作区配置
const WORKSPACE_CONFIG = {
  defaultSize: { width: 1920, height: 1080 },  // 默认工作区尺寸
  maxSize: { width: 8192, height: 8192 },      // 最大工作区尺寸
  minSize: { width: 100, height: 100 },        // 最小工作区尺寸
  autoExpand: true,                            // 是否自动扩展
  expandPadding: 200,                          // 扩展时的边距
  gridSize: 10,                                // 网格大小
  snapToGrid: false                            // 是否吸附网格
}

// 视口配置
const VIEWPORT_CONFIG = {
  maxScale: 64,                                // 最大缩放倍数
  minScale: 0.01,                              // 最小缩放倍数
  wheelZoomSpeed: 1.1,                         // 滚轮缩放速度
  panSpeed: 1.0,                               // 平移速度
  boundaryPadding: 1000                        // 边界外的可平移距离
}
```

### 状态管理

```typescript
interface WorkspaceState {
  // 工作区尺寸
  bounds: Rectangle
  
  // 视口变换
  viewport: {
    x: number
    y: number
    scale: number
  }
  
  // 配置
  config: WorkspaceConfig
}
```

## 用户体验

### 工作流程

1. **新建项目**
   - 创建默认尺寸工作区 (1920x1080)
   - 设置初始视口居中显示工作区

2. **添加内容**
   - 图层可以放置在工作区内或外
   - 超出工作区的内容正常显示但标记为"超出边界"

3. **工作区管理**
   - 自动扩展：当重要内容超出边界时自动扩展工作区
   - 手动调整：用户可以手动设置工作区尺寸
   - 适配内容：一键调整工作区以适配所有图层内容

4. **导出选项**
   - 导出工作区：仅导出工作区范围内的内容
   - 导出所有内容：导出所有图层的联合边界
   - 自定义范围：用户指定导出区域

### 性能优化策略

1. **渲染优化**
   - 视口裁剪：只渲染视口可见的图层部分
   - LOD系统：根据缩放级别调整渲染细节
   - 虚拟化：大量图层时使用虚拟滚动

2. **内存管理**
   - 懒加载：非可见图层延迟加载
   - 纹理缓存：智能管理GPU纹理内存
   - 图层合并：合并小图层以减少draw call

## 兼容性考虑

### 与现有功能的兼容性

1. **工具系统**：所有选择和绘制工具正常工作
2. **图层系统**：现有图层功能完全兼容
3. **变换操作**：支持在工作区内外进行变换
4. **导入导出**：支持多种尺寸和格式

### 迁移策略

1. **现有项目**：自动适配到新的工作区系统
2. **API兼容**：保持现有API的向后兼容性
3. **渐进升级**：用户可以逐步使用新功能

## 后续扩展

### 计划功能

1. **多工作区**：支持在同一项目中创建多个工作区
2. **工作区模板**：预设常用尺寸的工作区模板
3. **协作功能**：多用户在同一工作区中协作
4. **版本控制**：工作区配置的版本管理

### 技术债务

1. **性能监控**：添加渲染性能监控
2. **内存分析**：优化内存使用模式
3. **用户体验**：收集用户反馈并优化交互

## 变更历史

- **2025-07-26**：初始架构设计和文档创建
- 混合架构方案确定
- 核心接口设计完成

---

*此文档将随着架构演进持续更新*
